<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            /* Add slight padding */
            padding-top: 10px;
            /*align-items: center;*/
            height: 100vh;
        }

        #wrongmess {
            margin-left: 50%;
            transform: translateX(-50%);
            width: fit-content;
        }

        #error-container {
            color: red;
        }

        .imag {
            max-width: 25%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        #messageInputContainer {
            width: 100%;
            margin: 0 auto;
        }

        #inputWrapper {
            position: relative;
            width: 100%;
        }

        #uploadLabel {
            position: absolute;
            left: 8px;
            top: 54%;
            transform: translateY(-50%);
            cursor: pointer;
        }

        #uploadIcon {
            width: 20px;
            height: 20px;
            fill: #007BFF;
        }

        #message {
            padding-left: 36px;
        }

        .box {
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            width: 100%;
        }

        .button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 14px;
        }

        .button2 {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: rgb(0, 174, 0);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 14px;
        }

        #imageArea {
            width: fit-content;
            overflow: hidden;
            gap: 5px;
            height: 0px;
        }

        .pastedImage {
            width: 50px;
            height: 50px;
            padding-right: 4px;
            border-radius: 25%;
        }

        .button2:hover {
            background-color: rgb(0, 140, 0);
        }

        #message-container {
            word-wrap: break-word;
            overflow-wrap: break-word;
            height: fit-content !important;
        }

        #input-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        #message-container {
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
            /* Set the width */
            box-sizing: border-box;
            /* Include padding and border in the total width */
        }

        input[type="password"] {
            font-size: 14px;
        }

        .button-password {
            max-width: 500px;
            margin-left: 25%;
        }
    </style>
</head>

<body>
    <div id="htmlContent">
        <div id="text">
            <div id="input-container">
                <div id="error-container"></div>
                <input id="name" type="text" class="box" name="name" value="" placeholder="Enter your name!">
                <button type="button" class="button" name="button" id="button" onclick="setUsername()">
                    Let me chat!
                </button>
                <div id="message-container"></div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
        integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
        crossorigin="anonymous"></script>
    <script>
        function setMaxHeight() {
            const images = document.querySelectorAll('.imag');
            images.forEach(image => {
                const maxWidth = image.offsetWidth;
                image.style.maxHeight = `${maxWidth}px`;
            });
        }
        const messageContainer = document.querySelector('#message-container');
        const resizeObserver = new ResizeObserver(() => {
            setMaxHeight();
        });
        resizeObserver.observe(messageContainer);
        //window.open('https://www.youtube.com/watch?v=dQw4w9WgXcQ')
        let targetUsername = null;
        $('#text').css({
            backgroundColor: 'white',
            padding: '2rem',
            borderRadius: 5,
            boxShadow: '0 0 10px rgba(0, 0, 0, 0.1)',
            width: '100vw',
            maxWidth: '80vw',
            position: 'absolute',
            left: '50%',
            transform: 'translateX(-50%)'
        })
        let imagesToSend = [];
        let ctrlDown = false,
            ctrlKey = 17,
            cmdKey = 91,
            vKey = 86,
            cKey = 67;
        document.addEventListener('keydown', function (e) {
            if (e.keyCode === ctrlKey || e.keyCode === cmdKey) {
                ctrlDown = true;
            }
        });

        document.addEventListener('keyup', function (e) {
            if (e.keyCode === ctrlKey || e.keyCode === cmdKey) {
                ctrlDown = false;
            }
        });
        let socket = io.connect("https://chat4-p72x.onrender.com");
        let name = null;
        let canSend = true;
        let isIn = false;
        const maxLength = 5;
        let isMuted = false;
        let ent = false;
        let x = 0;
        //window.open('https://www.google.com/search?q=nigger&rlz=1C1YTUH_enUS1035US1036&oq=nigger&aqs=chrome..69i57j0i10i433i512l3j0i10i512l3j69i60.3286j1j7&sourceid=chrome&ie=UTF-8')
        let y = 0;
        let isAdmin = false;
        let isOpen = false;
        let cC = true;
        if (localStorage.getItem('succ') === null) localStorage.setItem('succ', false);
        let lllllll = false;
        document.addEventListener('keydown', (e) => {
            if (e.key === '`') {
                let g = prompt('What is the special password?');
                if (lllllll === true) return alert('You only get 1 try!');
                lllllll = true;
                socket.emit('guess', g);
            }
        })
        socket.on('recGuess', how => {
            if (!how) {
                alert('Wrong password. Saving...');
                localStorage.setItem('didFail', true);
            } else if (how) {
                alert('Correct! Saving...');
                localStorage.setItem('succ', true);
            }
        })
        socket.on('serv', (s) => {
            alert('nigger');
            cC = true;
        })
        socket.on('toolong', (s => {
            alert('This is becuase of Trevor Riordan.');
            cC = true;
        }))
        function setUsername() {
            if (cC) {
                cC = false;
                let name = document.getElementById('name').value;
                if (name === 'server') {
                    alert("nigger");
                    cC = true;
                    return;
                } else if (name.length > 20) {
                    alert("Username too long");
                    cC = true;
                    return;
                }
                socket.emit('setUsername', name);
            }
        }
        document.onkeydown = function (e) {
            if (e.keyCode === 13) {
                if (name === null) {
                    setUsername();
                } else if (!ent) {
                    enterPassword();
                } else {
                    sendMessage();
                }
            }
        }
        socket.on('shutTheFuckUp', m => {
            if (!isAdmin) {
                /*let w = !isMuted;*/
                isMuted = m;
                /*if (isMuted === false && w) {
                  alert('You have been muted!');
                } else if (isMuted === true && !w) {
                  alert('You have been unmuted!');
                }*/
            }
        })

        function enterPassword() {
            let isM = false;
            function isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            if (window.screen.width <= 600 || isMobile()) isM = true;
            socket.emit('enterP', document.getElementById('name').value, localStorage.getItem('succ'), isM);
        }
        socket.on('done', function (data) {
            name = data;
            isIn = true;
            document.getElementById('text').innerHTML = `
  <div id="error-container"></div>
  <div style="display: flex; flex-direction: column; align-items: center;">
    <input type="password" class="box" placeholder="Enter your password!" style="max-width: 500px;" id="name">
    <button type="button" name="button" class="button" style="max-width: 500px; margin-top: 8px; width: 100%;" onclick="enterPassword()">Enter password</button>
  </div>
  <div id="message-container"></div>`;
        })

        document.getID = function (id) {
            return document.getElementById(String(id));
        }
        socket.on('arerP', async __ => {
            if (name === null) {
                await socket.emit('Pres', 'good', __, __, isIn);
                return;
            }
            await socket.emit('Pres', 'bad', name, isAdmin, isIn);
        })
        let ctx;

        function addHTML() {
            //document.getElementById('text').style.position = '';
            //document.getElementById('text').style.left = '';
            if (!isAdmin) {
                document.getElementById('text').innerHTML = `<div id="error-container"></div>
                       <div id="messageInputContainer">
            <div id="inputWrapper">
                <label for="imageInput" id="uploadLabel">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9 7C9 4.23858 11.2386 2 14 2C16.7614 2 19 4.23858 19 7V15C19 18.866 15.866 22 12 22C8.13401 22 5 18.866 5 15V9C5 8.44772 5.44772 8 6 8C6.55228 8 7 8.44772 7 9V15C7 17.7614 9.23858 20 12 20C14.7614 20 17 17.7614 17 15V7C17 5.34315 15.6569 4 14 4C12.3431 4 11 5.34315 11 7V15C11 15.5523 11.4477 16 12 16C12.5523 16 13 15.5523 13 15V9C13 8.44772 13.4477 8 14 8C14.5523 8 15 8.44772 15 9V15C15 16.6569 13.6569 18 12 18C10.3431 18 9 16.6569 9 15V7Z" fill="currentColor"></path></svg>
                </label>
                <input type="text" class="box" placeholder="Send a message!" id="message">
            </div>
        </div>
        <input type="file" id="imageInput" accept="image/*" multiple style="display:none;">
                        <div id="imageArea"></div>
                         <button type = "button" class="button" name = "button" onclick = "sendMessage()">Send</button>
                         <div id = "message-container"></div>`;
            } else {
                document.getElementById('text').innerHTML = `<div id="error-container"></div>
                        <button type="button" name="button" class="button" onclick="openSettings()">Admin Settings</button>
                        <div id="this"></div>
                        <br/>
                        <div id="messageInputContainer">
            <div id="inputWrapper">
                <label for="imageInput" id="uploadLabel">                    
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9 7C9 4.23858 11.2386 2 14 2C16.7614 2 19 4.23858 19 7V15C19 18.866 15.866 22 12 22C8.13401 22 5 18.866 5 15V9C5 8.44772 5.44772 8 6 8C6.55228 8 7 8.44772 7 9V15C7 17.7614 9.23858 20 12 20C14.7614 20 17 17.7614 17 15V7C17 5.34315 15.6569 4 14 4C12.3431 4 11 5.34315 11 7V15C11 15.5523 11.4477 16 12 16C12.5523 16 13 15.5523 13 15V9C13 8.44772 13.4477 8 14 8C14.5523 8 15 8.44772 15 9V15C15 16.6569 13.6569 18 12 18C10.3431 18 9 16.6569 9 15V7Z" fill="currentColor"></path></svg>
                </label>
                <input type="text" class="box" placeholder="Send a message!" id="message">
            </div>
        </div>
        <input type="file" id="imageInput" accept="image/*" multiple style="display:none;">
                        <div id="imageArea"></div>
                         <button type = "button" name = "button" class="button" onclick = "sendMessage()">Send</button>
                         <div id = "message-container"></div>`;
            }
            setTimeout(() => {
                // TODO //
                document.getElementById('message').addEventListener('keydown', async e => {
                    if (ctrlDown && e.key.toLowerCase() === 'v') {
                        let wasBlob = false;
                        try {
                            const items = await navigator.clipboard.read();
                            for (const item of items) {
                                for (const type of item.types) {
                                    if (type.startsWith('image/')) {
                                        const blob = await item.getType(type);
                                        // 2 MB //
                                        if (blob.size > 2000000) {
                                            alert('Image is too big!!!!!!!!!');
                                            e.preventDefault();
                                            return;
                                        } else if (imagesToSend.length >= maxLength) {
                                            alert('Too many images uploaded!');
                                            e.preventDefault();
                                            return;
                                        } else {
                                            const url = URL.createObjectURL(blob);
                                            const img = document.createElement('img');
                                            img.src = url;
                                            img.className = 'pastedImage';
                                            const imageArea = document.getElementById('imageArea');
                                            imageArea.style.height = '50px';
                                            imageArea.appendChild(img);
                                            imagesToSend.push(blob);
                                        }
                                        wasBlob = true;
                                    }
                                }
                            }
                        } catch (err) {
                            console.error('Failed to read clipboard contents:', err);
                        }
                        if (wasBlob) {
                            e.preventDefault();
                        }
                    }
                })

                document.getElementById('imageInput').addEventListener('change', handleFileSelect);
                function handleFileSelect(event) {
                    const files = event.target.files;
                    if (files.length + imagesToSend.length > maxLength) {
                        alert('Too many images selected! Max allowed is ' + maxLength);
                        return;
                    }
                    const imageArea = document.getElementById('imageArea');
                    imageArea.style.height = '50px';
                    for (const file of files) {
                        // 2 MB //
                        if (file.size > 2000000) {
                            alert('Image is too big!!!!!!!!!');
                            continue;
                        }
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'pastedImage';
                        imageArea.appendChild(img);
                        imagesToSend.push(file);
                    }
                }
            })
        }
        function muteUser() {
            let targetUsername2 = document.getElementById('muteUserInput').value;
            socket.emit('muteUser', targetUsername2);
        }

        function impUser() {
            if (document.getElementById('ImpUserDiv') === null) return;
            if (document.getElementById('impUserInput') === null) return;
            let imp = document.getElementById('impUserInput').value;
            targetUsername = imp;
            inpersinating = true;
            document.getElementById('ImpUserDiv').innerHTML = `<p>Your username is now ${imp}</p>`;
        }
        socket.on('shuted', (targetUsername, isMuted) => {
            if (document.getElementById('muteUserDiv') === null) return;
            if (isMuted === 'User not found') {
                document.getElementById('muteUserDiv').innerHTML = `<p>User not found</p>`;
                return;
            }
            if (isMuted) {
                document.getElementById('muteUserDiv').innerHTML = `<p>${targetUsername} is muted</p>`;
            } else {
                document.getElementById('muteUserDiv').innerHTML = `<p>${targetUsername} is unmuted</p>`;
            }
        })
        socket.on('done2', function (data, isAd) {
            isAdmin = isAd;
            ent = true;
            name = data;
            addHTML();
        })
        socket.on('usernameIsUsed', function (data) {
            document.getElementById('message-container').innerHTML = '<p style="margin-left: 39%;">Username used</p>';
            cC = true;
        })
        socket.on('error2', function (data) {
            document.getElementById('message-container').innerHTML = '<p id="wrongmess">Wrong password</p>';
        })
        socket.on('movement', function (data) {
            if (name !== null && ent) {
                let canvas = document.getElementById('campusImage');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                socket.emit('getP', 0);
            }
        })
        let inpersinating = false;
        const blobToBase64 = blob => {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            return new Promise(resolve => {
                reader.onloadend = () => {
                    resolve(reader.result);
                };
            });
        };
        function listOfBlobsToBase64(blobs) {
            return new Promise((resolve, reject) => {
                let newBlobs = [];
                let i = 0;
                async function one(cur) {
                    if (!cur) cur = blobs[0];
                    let base64 = await blobToBase64(cur);
                    newBlobs.push(base64);
                    ++i;
                    if (i + 1 <= blobs.length) {
                        one(blobs[i]);
                    } else {
                        resolve(newBlobs);
                    }
                }
                one();
            })
        }
        async function sendMessage() {
            if (inpersinating) {
                // You can send a message as long as you want... //
                let impersonateUsername = targetUsername; // Replace this with the actual username you want to impersonate
                if (canSend) {
                    const imageArea = document.getElementById('imageArea');
                    imageArea.innerHTML = '';
                    imageArea.style.height = 0;
                    let message = document.getElementById('message').value;
                    if (!imagesToSend.length) {
                        socket.emit('sendM', message, isAdmin ? impersonateUsername : `My Name is ${name} and I am trying to hack your website! Please ban me!`, true);
                    } else {
                        let totalSize = 0;
                        for (const image of imagesToSend) {
                            totalSize += image.size;
                        }
                        // 10 MB //
                        if (totalSize > 10000000) {
                            alert('Sending failed. Try to send smaller images and/or less images!!');
                        } else {
                            canSend = false;
                            let sixtyFours = await listOfBlobsToBase64(imagesToSend);
                            socket.emit('sendM', message, isAdmin ? impersonateUsername : `My Name is ${name} and I am trying to hack your website! Please ban me!`, true, sixtyFours);
                        }
                    }
                    imagesToSend = [];
                    document.getElementById('message').value = '';
                    canSend = false;
                    setTimeout(function () {
                        canSend = true;
                    }, 2000);
                }
            } else {
                if (canSend && !isMuted) {
                    const imageArea = document.getElementById('imageArea');
                    imageArea.innerHTML = '';
                    imageArea.style.height = 0;
                    let message = document.getElementById('message').value;
                    if (message.length > 500) {
                        alert('This is because of Lorenzo Digebe');
                        while (true) {
                            let num = Math.floor(Math.random() * 5) + 1;
                            let guess = Number(prompt('Pick a number 1-5'));
                            if (isNaN(guess)) {
                                alert('Please enter a number!');
                            } else if (String(guess).length > 2) {
                                alert('Too big.');
                            } else if (guess === num) {
                                alert('Good boy');
                                alert('Good boy');
                                break;
                            } else {
                                alert('Nope');
                            }
                        }
                        return;
                    }
                    if (!imagesToSend.length) {
                        socket.emit('sendM', message, isAdmin ? name : null, false);
                    } else {
                        let totalSize = 0;
                        for (const image of imagesToSend) {
                            totalSize += image.size;
                        }
                        // 10 MB //
                        if (totalSize > 10000000) {
                            alert('Sending failed. Try to send smaller images and/or less images!!');
                        } else {
                            canSend = false;
                            let sixtyFours = await listOfBlobsToBase64(imagesToSend);
                            socket.emit('sendM', message, isAdmin ? name : null, false, sixtyFours);
                        }
                    }
                    imagesToSend = [];
                    document.getElementById('message').value = '';
                    canSend = false;
                    setTimeout(function () {
                        canSend = true;
                    }, 2000);
                }
            }
        }


        function shut() {
            socket.emit('onlyAS', isAdmin);
        }

        function shut1(user) {
            socket.emit('muteUser', user);
        }
        socket.on('Done', (what, text) => {
            document.getElementById(what).innerText = text;
        })
        socket.on('doneopen', (onlyAdminSpeak, onlyAS, settingHTML) => {
            document.getElementById('this').innerHTML = settingHTML;
            setTimeout(() => {
                document.getElementById(onlyAS).innerHTML = onlyAdminSpeak ? 'On' : 'Off';
            }, 300)
        })

        function openSettings() {
            isOpen = !isOpen;
            if (isOpen) {
                socket.emit('open', undefined);
            } else {
                document.getElementById('this').innerHTML = ``;
            }
        }

        function isAdminMessage(message, admins) {
            // Check if the message starts with the admin prefix
            if (admins.length) {
                for (const admin of admins) {
                    // Add the correct comparison condition here
                    if (message.startsWith(` ${admin}:`)) return true;
                }
            }
            return false;
        }

        function executeScriptFromMessage(message, isLastMessage) {
            if (!isLastMessage) return;
            if (message.split(':')[1].startsWith(' runJS')) {
                let content = message.split(':')[1].slice(7, message.split(':')[1].length);
                const scriptElement = document.createElement('script');
                scriptElement.textContent = content;
                document.body.appendChild(scriptElement);
            }
        }

        socket.on('addMessages', function (messages, admins, images) {
            if (name !== null && ent) {
                // Read messages, if message was made by an admin, allow the HTML to run. If not, do not. A message looks like: "<br> Username: Message" //
                let messageArray = messages.split("<br>");
                let sanitizedMessages = [];

                messageArray.forEach((message, ind) => {
                    if (isAdminMessage(message, admins)) {
                        executeScriptFromMessage(message, ind === messageArray.length - 1);
                        sanitizedMessages.push(message);
                    } else {
                        // Sanitize non-admin messages to prevent the execution of HTML
                        sanitizedMessages.push(message.replace(/</g, "&lt;").replace(/>/g, "&gt;"));
                    }
                });
                if (images.length) {
                    images.forEach((imgs, ind) => {
                        if (imgs.length) {
                            for (const img of imgs) {
                                sanitizedMessages[ind + 1] += `<div></div><img class="imag" src="${img}"/>`;
                            }
                        }
                    })
                }
                // Join the sanitized messages back into a single string
                let sanitizedMessagesHTML = sanitizedMessages.join("<br>");
                document.getElementById('message-container').innerHTML = sanitizedMessagesHTML;
            }
        });

        socket.on('addMessage', function (message, admins, imgs) {
            if (name !== null && ent) {
                const messageContainer = document.getElementById('message-container');
                let messageArray = messageContainer.innerHTML.split("<br>");
                let sanitizedMessage = '<br>';
                if (isAdminMessage(message, admins)) {
                    executeScriptFromMessage(message, true);
                    sanitizedMessage += message;
                } else {
                    sanitizedMessage += message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                }
                if (imgs.length) {
                    for (const img of imgs) {
                        sanitizedMessage += `<div></div><img class="imag" src="${img}"/>`;
                    }
                }
                document.getElementById('message-container').innerHTML += sanitizedMessage;
            }
        })
    </script>
</body>

</html>