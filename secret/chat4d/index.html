<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            /* Add slight padding */
            padding-top: 10px;
            /*align-items: center;*/
            height: 100vh;
        }
        
        #error-container {
            color: red;
        }
        
        .box {
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            width: 100%;
        }
        
        .button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 14px;
        }
        
        .button2 {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background-color: rgb(0, 174, 0);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 14px;
        }
        
        .button2:hover {
            background-color: rgb(0, 140, 0);
        }
        
        #message-container {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        #input-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #message-container {
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 100%;
            /* Set the width */
            box-sizing: border-box;
            /* Include padding and border in the total width */
        }
        
        input[type="password"] {
            font-size: 14px;
        }
        
        .button-password {
            max-width: 500px;
            margin-left: 25%;
        }
    </style>
</head>

<body>
    <div id="htmlContent">
        <div id="text">
            <div id="input-container">
                <div id="error-container"></div>
                <input id="name" type="text" class="box" name="name" value="" placeholder="Enter your name!">
                <button type="button" class="button" name="button" id="button" onclick="setUsername()">
                    Let me chat!
                </button>
                <div id="message-container"></div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
    <script>
        let targetUsername = null;
        $('#text').css({
            backgroundColor: 'white',
            padding: '2rem',
            borderRadius: 5,
            boxShadow: '0 0 10px rgba(0, 0, 0, 0.1)',
            width: '200%',
            maxWidth: window.innerWidth < 1000 ? '70%' : 1000,
            position: 'absolute', // Change 'relative' to 'absolute'
            left: '50%', // Change '-50%' to '50%'
            transform: 'translateX(-50%)' // Add this line to horizontally center the element
        })

        let socket = io.connect('https://chat4d-lyart.vercel.app/');
        let name = null;
        let canSend = true;
        let isMuted = false;
        let ent = false;
        let x = 0;
        let y = 0;
        let isAdmin = false;
        let isOpen = false;
        let cC = true;

        function setUsername() {
            if (cC) {
                cC = false;
                let name = document.getElementById('name').value;
                socket.emit('setUsername', name);
            }
        }
        document.onkeydown = function(e) {
            if (e.keyCode === 13) {
                if (name === null) {
                    setUsername();
                } else if (!ent) {
                    enterPassword();
                } else {
                    sendMessage();
                }
            }
        }
        socket.on('shutTheFuckUp', m => {
            if (!isAdmin) {
                isMuted = m;
            }
        })

        function enterPassword() {
            socket.emit('enterP', document.getElementById('name').value);
        }
        socket.on('done', function(data) {
            name = data;
            document.getElementById('text').innerHTML = `
  <div id="error-container"></div>
  <div style="display: flex; flex-direction: column; align-items: center;">
    <input type="password" class="box" placeholder="Enter your password!" style="max-width: 500px;" id="name">
    <button type="button" name="button" class="button" style="max-width: 500px; margin-top: 8px; width: 100%;" onclick="enterPassword()">Enter password</button>
  </div>
  <div id="message-container"></div>`;
        })

        document.getID = function(id) {
            return document.getElementById(String(id));
        }
        socket.on('arerP', async __ => {
            if (name === null) {
                await socket.emit('Pres', 'good', __, __);
                return;
            }
            await socket.emit('Pres', 'bad', name, isAdmin);
        })
        let ctx;

        function addHTML() {
            //document.getElementById('text').style.position = '';
            //document.getElementById('text').style.left = '';
            if (!isAdmin) {
                document.getElementById('text').innerHTML = `<div id="error-container"></div>
                        <input type = "text" class="box" placeholder="Send a message!" id = "message"><br>
                         <button type = "button" class="button" name = "button" onclick = "sendMessage()">Send</button>
                         <div id = "message-container"></div>`;
            } else {
                document.getElementById('text').innerHTML = `<div id="error-container"></div>
                        <button type="button" name="button" class="button" onclick="openSettings()">Admin Settings</button>
                        <div id="this"></div>
                        <br/>
                        <input type = "text" class="box" placeholder="Send a message!" id = "message"><br>
                         <button type = "button" name = "button" class="button" onclick = "sendMessage()">Send</button>
                         <div id = "message-container"></div>`;
            }
        }

        function muteUser() {
            let targetUsername2 = document.getElementById('muteUserInput').value;
            socket.emit('muteUser', targetUsername2);
        }

        function impUser() {
            if (document.getElementById('ImpUserDiv') === null) return;
            if (document.getElementById('impUserInput') === null) return;
            let imp = document.getElementById('impUserInput').value;
            targetUsername = imp;
            inpersinating = true;
            document.getElementById('ImpUserDiv').innerHTML = `<p>Your username is now ${imp}</p>`;
        }
        socket.on('shuted', (targetUsername, isMuted) => {
            if (document.getElementById('muteUserDiv') === null) return;
            if (isMuted === 'User not found') {
                document.getElementById('muteUserDiv').innerHTML = `<p>User not found</p>`;
                return;
            }
            if (isMuted) {
                document.getElementById('muteUserDiv').innerHTML = `<p>${targetUsername} is muted</p>`;
            } else {
                document.getElementById('muteUserDiv').innerHTML = `<p>${targetUsername} is unmuted</p>`;
            }
        })
        socket.on('done2', function(data, isAd) {
            isAdmin = isAd;
            ent = true;
            name = data;
            addHTML();
        })
        socket.on('usernameIsUsed', function(data) {
            document.getElementById('message-container').innerHTML = '<p style="margin-left: 39%;">Username used</p>';
            cC = true;
        })
        socket.on('error2', function(data) {
            document.getElementById('message-container').innerHTML = '<p style="margin-left: 44%;">Wrong password</p>';
        })
        socket.on('movement', function(data) {
            if (name !== null && ent) {
                let canvas = document.getElementById('campusImage');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                socket.emit('getP', 0);
            }
        })
        let inpersinating = false;

        function sendMessage() {
            if (inpersinating) {
                let impersonateUsername = targetUsername; // Replace this with the actual username you want to impersonate
                if (canSend) {
                    let message = document.getElementById('message').value;
                    socket.emit('sendM', message, isAdmin ? impersonateUsername : `My Name is ${name} and I am trying to hack your website! Please ban me!`, true);
                    canSend = false;
                    setTimeout(function() {
                        canSend = true;
                    }, 2000);
                }
            } else {
                if (canSend && !isMuted) {
                    let message = document.getElementById('message').value;
                    socket.emit('sendM', message, isAdmin ? name : null, false);
                    canSend = false;
                    setTimeout(function() {
                        canSend = true;
                    }, 2000);
                }
            }
        }


        function shut() {
            socket.emit('onlyAS', isAdmin);
        }

        function shut1(user) {
            socket.emit('muteUser', user);
        }
        socket.on('Done', (what, text) => {
            document.getElementById(what).innerText = text;
        })
        socket.on('doneopen', (onlyAdminSpeak, onlyAS, settingHTML) => {
            document.getElementById('this').innerHTML = settingHTML;
            setTimeout(() => {
                document.getElementById(onlyAS).innerHTML = onlyAdminSpeak ? 'On' : 'Off';
            }, 300)
        })

        function openSettings() {
            isOpen = !isOpen;
            if (isOpen) {
                socket.emit('open', undefined);
            } else {
                document.getElementById('this').innerHTML = ``;
            }
        }

        function isAdminMessage(message, admins) {
            // Check if the message starts with the admin prefix
            if (admins.length) {
                for (const admin of admins) {
                    // Add the correct comparison condition here
                    if (message.startsWith(` ${admin}:`)) return true;
                }
            }
            return false;
        }

        function executeScriptFromMessage(message, isLastMessage) {
            if (!isLastMessage) return;
            console.log(message.split(':')[1]);
            if (message.split(':')[1].startsWith(' runJS')) {
                let content = message.split(':')[1].slice(7, message.split(':')[1].length);
                console.log(content)
                const scriptElement = document.createElement('script');
                scriptElement.textContent = content;
                document.body.appendChild(scriptElement);
            }
        }

        socket.on('addMessage', function(messages, admins) {
            if (name !== null && ent) {
                // Read messages, if message was made by an admin, allow the HTML to run. If not, do not. A message looks like: "<br> Username: Message" //
                let messageArray = messages.split("<br>");
                let sanitizedMessages = [];

                messageArray.forEach((message, ind) => {
                    if (isAdminMessage(message, admins)) {
                        executeScriptFromMessage(message, ind === messageArray.length - 1);
                        sanitizedMessages.push(message);
                    } else {
                        // Sanitize non-admin messages to prevent the execution of HTML
                        sanitizedMessages.push(message.replace(/</g, "&lt;").replace(/>/g, "&gt;"));
                    }
                });
                // Join the sanitized messages back into a single string
                let sanitizedMessagesHTML = sanitizedMessages.join("<br>");

                document.getElementById('message-container').innerHTML = sanitizedMessagesHTML;
                updateMessageContainerHeight();
            }
        });

        function updateMessageContainerHeight() {
            let messageContainer = $('#message-container');
            let minHeight = 50; // Set the minimum height of the message container
            let maxHeight = Infinity; // Set the maximum height of the message container

            // Reset the height to 'auto' to recalculate the scrollHeight
            messageContainer.css('height', 'auto');
            let newHeight = messageContainer.prop('scrollHeight');

            // Clamp the new height between minHeight and maxHeight
            newHeight = Math.min(Math.max(newHeight, minHeight), maxHeight);

            // Set the new height and make it scrollable if it reaches maxHeight
            messageContainer.css({
                'height': newHeight,
                'overflow-y': newHeight === maxHeight ? 'auto' : 'visible'
            });
        }
    </script>
</body>

</html>